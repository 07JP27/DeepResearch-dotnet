@page "/"
@using DeepResearch.Core.Events
@using System.Text.Json
@inject IJSRuntime JSRuntime
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Deep Research</PageTitle>

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Deep Research</h1>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Research Input Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">調査トピックを入力してください</h2>
            <div class="flex space-x-4">
                <input @bind="researchTopic" @onkeypress="OnKeyPress" placeholder="例: AIによる医療画像診断の最新動向"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    disabled="@isResearching" />
                <button @onclick="StartResearch" disabled="@(isResearching || string.IsNullOrWhiteSpace(researchTopic))"
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    @if (isResearching)
                    {
                        <span class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                                </circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            調査中...
                        </span>
                    }
                    else
                    {
                        <span>調査開始</span>
                    }
                </button>
            </div>
        </div>

        <!-- Progress Display -->
        @if (isResearching || researchSteps.Any())
        {
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">調査進行状況</h3>
                <div class="space-y-4">
                    @foreach (var step in researchSteps)
                    {
                        <div class="border-l-4 @(GetStepBorderColor(step.Type)) pl-4 py-2">
                            <div class="flex items-center mb-2">
                                <span class="@(GetStepIconColor(step.Type)) mr-2">@GetStepIcon(step.Type)</span>
                                <h4 class="font-medium text-gray-900">@GetStepTitle(step.Type)</h4>
                                <span class="ml-auto text-sm text-gray-500">@step.Timestamp.ToString("HH:mm:ss")</span>
                            </div>
                            @if (!string.IsNullOrEmpty(step.Content))
                            {
                                <div class="text-gray-700 text-sm mt-2">
                                    @((MarkupString)step.Content)
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Final Research Report -->
        @if (!string.IsNullOrEmpty(finalReport))
        {
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">調査レポート</h3>

                <!-- Images Section -->
                @if (finalImages.Any())
                {
                    <div class="mb-6">
                        @if (finalImages.Count >= 2)
                        {
                            <div class="flex flex-col md:flex-row gap-4 mb-6">
                                <div class="w-full md:w-1/2">
                                    <img src="@finalImages[0]" alt="Research image 1" class="w-full h-auto rounded-lg shadow-md" />
                                </div>
                                <div class="w-full md:w-1/2">
                                    <img src="@finalImages[1]" alt="Research image 2" class="w-full h-auto rounded-lg shadow-md" />
                                </div>
                            </div>
                        }
                        else if (finalImages.Count == 1)
                        {
                            <div class="flex justify-center mb-6">
                                <div class="w-full max-w-lg">
                                    <img src="@finalImages[0]" alt="Research image" class="w-full h-auto rounded-lg shadow-md" />
                                </div>
                            </div>
                        }
                    </div>
                }

                <div class="prose max-w-none">
                    @((MarkupString)finalReport)
                </div>
            </div>
        }
    </main>
</div>

@code {
    private string researchTopic = "";
    private bool isResearching = false;
    private List<ResearchStep> researchSteps = new();
    private string finalReport = "";
    private List<string> finalImages = new();
    private string clientId = Guid.NewGuid().ToString();
    private Timer? pollingTimer;
    private int lastProgressCount = 0;

    public class ResearchStep
    {
        public string Type { get; set; } = "";
        public string Content { get; set; } = "";
        public DateTime Timestamp { get; set; } = DateTime.Now;
    }

    private void StartPolling()
    {
        // 既存のタイマーがあれば停止
        pollingTimer?.Dispose();
        pollingTimer = new Timer(async _ => await PollProgress(), null, TimeSpan.Zero, TimeSpan.FromMilliseconds(1000));
    }

    private void StopPolling()
    {
        pollingTimer?.Dispose();
        pollingTimer = null;
    }

    private async Task PollProgress()
    {
        try
        {
            var url = Navigation.ToAbsoluteUri($"/api/research/progress/{clientId}?fromIndex={lastProgressCount}");
            var response = await HttpClient.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<ProgressResponse>(content, new
                System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (result != null)
                {
                    isResearching = result.IsResearching;

                    foreach (var progress in result.Progress)
                    {
                        await InvokeAsync(() => HandleProgressUpdate(progress));
                    }

                    lastProgressCount = result.TotalCount;
                    await InvokeAsync(StateHasChanged);

                    // 調査が完了したらポーリングを停止
                    if (!isResearching)
                    {
                        StopPolling();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ポーリングエラー: {ex.Message}");
        }
    }

    private async Task StartResearch()
    {
        if (string.IsNullOrWhiteSpace(researchTopic) || isResearching)
            return;

        researchSteps.Clear();
        finalReport = "";
        lastProgressCount = 0;
        StateHasChanged();

        try
        {
            var request = new
            {
                Topic = researchTopic,
                ClientId = clientId
            };

            var json = System.Text.Json.JsonSerializer.Serialize(request);
            var httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

            var url = Navigation.ToAbsoluteUri("/api/research/start");
            var response = await HttpClient.PostAsync(url, httpContent);

            if (response.IsSuccessStatusCode)
            {
                // 調査が正常に開始されたらポーリングを開始
                StartPolling();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                researchSteps.Add(new ResearchStep
                {
                    Type = "error",
                    Content = $"エラーが発生しました: {errorContent}"
                });
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            researchSteps.Add(new ResearchStep
            {
                Type = "error",
                Content = $"エラーが発生しました: {ex.Message}"
            });
            StateHasChanged();
        }
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isResearching && !string.IsNullOrWhiteSpace(researchTopic))
        {
            await StartResearch();
        }
    }

    private Task HandleProgressUpdate(ProgressMessage message)
    {
        var type = message.Type;
        var data = message.Data;

        var content = "";

        switch (type)
        {
            case ProgressTypes.Thinking:
                if (data.TryGetProperty("message", out var msgElement))
                    content = msgElement.GetString() ?? "";
                break;
            case ProgressTypes.GenerateQuery:
                var query = data.TryGetProperty("query", out var queryElement) ? queryElement.GetString() ?? "" : "";
                var rationale = data.TryGetProperty("rationale", out var rationaleElement) ? rationaleElement.GetString() ?? "" : "";
                content = $"<strong>検索クエリ:</strong> {query}<br><strong>根拠:</strong> {rationale}";
                break;
            case ProgressTypes.Routing:
                content = $"<strong>次の処理を判断</strong>";
                break;
            case ProgressTypes.WebResearch:
                if (data.TryGetProperty("sources", out var sources))
                {
                    content = $"<strong>検索結果:</strong> {sources.GetArrayLength()} 件のソースを発見";
                }
                break;
            case ProgressTypes.Summarize:
                if (data.TryGetProperty("summary", out var summary))
                {
                    content = $"<strong>要約:</strong><br>{summary.GetString()}";
                }
                break;
            case ProgressTypes.Reflection:
                if (data.TryGetProperty("knowledge_gap", out var gap))
                {
                    content = $"<strong>知識ギャップ:</strong> {gap.GetString()}";
                }
                break;
            case ProgressTypes.Finalize:
                if (data.TryGetProperty("summary", out var finalSummary))
                {
                    finalReport = finalSummary.GetString() ?? "";
                }
                if (data.TryGetProperty("images", out var imagesJson) && imagesJson.ValueKind == JsonValueKind.Array)
                {
                    finalImages.Clear();
                    foreach (var imageElement in imagesJson.EnumerateArray())
                    {
                        var imageUrl = imageElement.GetString();
                        if (!string.IsNullOrEmpty(imageUrl))
                        {
                            finalImages.Add(imageUrl);
                        }
                    }
                }
                return Task.CompletedTask;
            case ProgressTypes.ResearchComplete:
                if (data.TryGetProperty("final_summary", out var completeSummary))
                {
                    finalReport = completeSummary.GetString() ?? "";
                }
                if (data.TryGetProperty("images", out var completeImagesJson) && completeImagesJson.ValueKind == JsonValueKind.Array)
                {
                    finalImages.Clear();
                    foreach (var imageElement in completeImagesJson.EnumerateArray())
                    {
                        var imageUrl = imageElement.GetString();
                        if (!string.IsNullOrEmpty(imageUrl))
                        {
                            finalImages.Add(imageUrl);
                        }
                    }
                }
                content = "<strong>調査が完了しました！</strong>";
                break;
        }

        if (!string.IsNullOrEmpty(content) || type == ProgressTypes.ResearchComplete)
        {
            researchSteps.Add(new ResearchStep { Type = type, Content = content });
        }

        return Task.CompletedTask;
    }

    private string GetStepBorderColor(string type) => type switch
    {
        ProgressTypes.Thinking => "border-yellow-400",
        ProgressTypes.GenerateQuery => "border-blue-400",
        ProgressTypes.WebResearch => "border-purple-400",
        ProgressTypes.Summarize => "border-green-400",
        ProgressTypes.Reflection => "border-orange-400",
        ProgressTypes.Finalize => "border-indigo-400",
        ProgressTypes.ResearchComplete => "border-green-500",
        "error" => "border-red-400",
        _ => "border-gray-400"
    };

    private string GetStepIconColor(string type) => type switch
    {
        ProgressTypes.Thinking => "text-yellow-500",
        ProgressTypes.GenerateQuery => "text-blue-500",
        ProgressTypes.Routing => "text-gray-500",
        ProgressTypes.WebResearch => "text-purple-500",
        ProgressTypes.Summarize => "text-green-500",
        ProgressTypes.Reflection => "text-orange-500",
        ProgressTypes.Finalize => "text-indigo-500",
        ProgressTypes.ResearchComplete => "text-green-600",
        "error" => "text-red-500",
        _ => "text-gray-500"
    };

    private string GetStepIcon(string type) => type switch
    {
        ProgressTypes.Thinking => "💭",
        ProgressTypes.GenerateQuery => "🔍",
        ProgressTypes.Routing => "🔀",
        ProgressTypes.WebResearch => "🌐",
        ProgressTypes.Summarize => "📝",
        ProgressTypes.Reflection => "🤔",
        ProgressTypes.Finalize => "📋",
        ProgressTypes.ResearchComplete => "✅",
        "error" => "❌",
        _ => "📄"
    };

    private string GetStepTitle(string type) => type switch
    {
        ProgressTypes.Thinking => "思考中",
        ProgressTypes.GenerateQuery => "検索クエリ生成",
        ProgressTypes.Routing => "処理のルーティング",
        ProgressTypes.WebResearch => "Web検索",
        ProgressTypes.Summarize => "要約作成",
        ProgressTypes.Reflection => "反省・知識ギャップ分析",
        ProgressTypes.Finalize => "最終レポート作成",
        ProgressTypes.ResearchComplete => "調査完了",
        "error" => "エラー",
        _ => "処理中"
    };

    public async ValueTask DisposeAsync()
    {
        StopPolling();

        try
        {
            // 進行状況をクリア
            var url = Navigation.ToAbsoluteUri($"/api/research/progress/{clientId}");
            await HttpClient.DeleteAsync(url);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"クリーンアップエラー: {ex.Message}");
        }
    }

    public class ProgressResponse
    {
        public List<ProgressMessage> Progress { get; set; } = new();
        public bool IsResearching { get; set; }
        public int TotalCount { get; set; }
    }

    public class ProgressMessage
    {
        public string Type { get; set; } = "";
        public System.Text.Json.JsonElement Data { get; set; }
        public DateTime Timestamp { get; set; }
    }
}
    